# Simple Ansible Operator


Step by step guide that includes building, running and testing an operator scenarios on a local OS.

Before starting creating your first simple operator, you require to install all tools.

Prerequisites:

Choose any beloved provider:
* [Podman](https://podman.io/getting-started/)
* [Docker](https://docs.docker.com/get-docker/)

Install cluster and SDK:
* [Kind Cluster](https://kind.sigs.k8s.io/docs/user/quick-start/)
* [Operator-SDK](https://sdk.operatorframework.io/docs/building-operators/ansible/installation/)

> Running a kind cluster using podman provider doesn't work on MacOS and has an [open issue](https://>github.com/kubernetes-sigs/kind/issues/2233#issuecomment-837861552) on Github.

Once you've installed Kind package locally, to accelerate the installation process you can run the  `setup_dev_env.sh` script.

Kind config, aliases, Internal Registry and Ingress (Nginx) will be created.

If you want to set own environment aliases, please modify the snippet in advance.

Setting up development environment and creating a full pack kind cluster.

```bash
$ ./scripts/setup_dev_env.sh
$ oc get no; oc get ns
```

Shortcuts that can save you time.
```bash
cat <<EOF >> ~/.bash_profile

# Kind cluster operations shortcuts.
alias kstart="cat ~/.kind/.config | kind create cluster --name=magpie --config=-"
alias kdel="kind delete cluster --name=magpie"
alias kpodman="KIND_EXPERIMENTAL_PROVIDER=podman kind create cluster"

# Build operator
alias opb="make docker-build docker-push"
# Deploy operator
alias opd="make deploy"
# Undeploy operator
alias opun="make undeploy"
# Delete all frog stuff, build operator and deploy.
alias opre="make undeploy; make docker-build docker-push; make deploy;"
EOF
. ~/.bash_profile
```

## Creating a skeleton using operator SDK.
```bash
$ mkdir frog-operator; cp -fr samples frog-operator; cd $_
$ MY_OPERATOR=FROG

# Invokes "create api" as well.
$ operator-sdk init  --domain domain.com --plugins ansible --group=lake --version=v1alpha1 --kind=${MY_OPERATOR} --generate-role --generate-playbook
```

Your desired output should be:

`Writing kustomize manifests for you to edit...`.

At the moment of writing, `requirements.yaml` generated by SDK has old kubernetes collection, therefore it requires to update it manually by replacing it with below context.

```bash
cat << EOF > requirements.yml
---
collections:
  - name: kubernetes.core
  - name: community.general
  - name: operator_sdk.util
    version: "0.2.0"
EOF
```

Create Frog CRD on the running cluster using OC command.

```bash
$ oc create -f config/crd/bases/lake.domain.com_frogs.yaml
```

## Configure Frog operator image registry.

Your `Makefile` has a default version tag and image base tag variables. Modify the local registry and image name.

You have to set `localhost:5000` registry to be able to push an image into local registry.

Example:

```bash
IMAGE_TAG_BASE ?= localhost:5000/frog-operator
IMG ?= $(IMAGE_TAG_BASE):$(VERSION)
```

Modify the `IMG` variable as it is described.


## Build and deploy Frog operator.

Replace an existing genarated role with the sample ansible role and RBAC cluster role, clean up samples.
```bash
$ rm -rf roles/frog; cp -rf samples/ansible/frog/role roles/frog &&
  cp -fr samples/ansible/frog/rbac/role.yaml config/rbac/role.yaml &&
  rm -fr samples
```

Once the CRD is deployed on the cluster, and image tag is set, the following command will build an operator image.

You can build the operator using alias `opb` as well.

Build using alias
```bash
$ opb
```
Build using Operator-SDK command
```bash
$ make docker-build docker-push
```

Test an operator locally outside the cluster, verify that it's running properly.
```bash
$ make install run
```

Deploy an operator to your local k8s kind cluster.

Deploy using alias
```bash
$ opd
```
Deploy using Operator-SDK command
```bash
$ make deploy
```
Verify Frog operator is up and running.
```bash
$ oc project frog-operator-system; oc get po
NAME                                                   READY   STATUS    RESTARTS   AGE
ansible-operator-controller-manager-79d87bfccb-9g8qr   2/2     Running   0          2m45s
# Check logs
$ oc logs -f $(oc get po | tail -n +2 | awk '{print $1}') -c manager
```

>You can open a new terminal tab to monitor the operator actions in logs before creating a CR to provision simple Frog operator.

```
$ oc create -f config/samples/lake_v1alpha1_frog.yaml
```

Be courage and test the stuff :)

```bash
$ oc get po -n frog-app
$ curl localhost/frog
```

Conclusion:

You've just created a simple ansible operator that deploys Frog app only.

Please consider, that it's not production ready example, you would require to drive into Custom Resource validation, fine-tunning permissive RBAC role, etc.

You have to revise `roles/frog/tasks/main.yaml` to have a notion what exactly it does.

Recommendations:

* Create an ansible role first, test it out and then integrate that role into an operator logic.

* If you are learning the ropes, I highly recommend you to read the book [Kubenetes Operators](https://www.oreilly.com/library/view/kubernetes-operators/9781492048039/) was written by Jason Dobies and Joshua Wood.

Now you're one step closer, Happy Automation :)
